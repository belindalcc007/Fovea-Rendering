function svistest
% SVISTEST   Test space variant imaging system functions

% Copyright (C) 2004-2006
% Center for Perceptual Systems
%
% jsp Thu Apr  8 15:59:22 CDT 2004

folder='/home/zharuvrl/Projects/Arcade-Learning-Environment/mypylink/screen_record/31_RZ_4808953_May-14-19-46-50/';
ascFile='/home/zharuvrl/Projects/Arcade-Learning-Environment/mypylink/screen_record/31_RZ_4808953_May-14-19-46-50.asc';
maparc=100;
saveFolderName=stract('31_', num2str(maparc));
saveFolder=strcat(saveFolderName,'/');
mkdir(saveFolder);
fid=fopen(ascFile,'r');

filenames=dir(strcat(folder,'*.png'));
filenames={filenames.name};
filenames=natsortfiles(filenames); %sort files according to frameid numerically
num_files = size(filenames,2);
num_files
svisinit;
%svisrelease;

for f=1:num_files
    if mod(f
    temp=strsplit(char(filenames(f)),'_');
    utid=strcat(temp(1),'_',temp(2));
    temp2=strsplit(char(temp(3)),'.');
    frameid=temp2(1);
    
    foundKeyPress=false;
    foundFrameID=false;
    target=strcat('FRAMEID',{' '},frameid, {' '});
    % read line by line to get gaze position
    while ~foundKeyPress || ~foundFrameID
        line=fgets(fid);
        if size(strfind(line,target),2) ~= 0
            foundFrameID=true;
        end
        % get xpos,ypos if this is a gaze dataline
        if size(strfind(line,'...'),2) ~= 0
            gaze_pos=strsplit(line);
            xpos=str2double(gaze_pos(2))/8; %xscale: x is column
            ypos=str2double(gaze_pos(3))/4; %yscale: y is row
        end
        if size(strfind(line,'key_pressed'),2) ~= 0 % find last gaze pos
            foundKeyPress=true;
        end
    end
    
    img=imread(strcat(folder,char(filenames(f))));
    img=rgb2gray(img);
    ROWS=size(img,1);
    COLS=size(img,2);   

    c=sviscodec(img);

    r=svisresmap(ROWS*2,COLS*2,'maparc',maparc);
    %r2=svisresmap(ROWS*2,COLS*2,'halfres',10.0,'maparc',80.0);
    %r2=uint8(255-r2);
    svissetresmap(c,r);
  
    dest=svisencode(c,ypos,xpos);
    imwrite(dest, strcat(saveFolder,char(filenames(f))));
    %h1=show(dest);
    %h4=show(img);

    %svissetsrc(c,fliplr(img));
    %dest=svisencode(c,ROWS,COLS);
    %h2=show(dest);
    % alloc another codec
    %c2=sviscodec(img);
    %r2=uint8(rand(size(r))*255);
    %svissetresmap(c2,r2);
    %dest=svisencode(c2,ROWS/2,COLS/2);
    %h3=show(dest);
  
end

svisrelease; 
fclose(fid);

tar(strcat(saveFolderName,'_foveated.tar.gz'), saveFolder)

%close(h1);
%close(h2);
%close(h3);
%close(h4);

%disp 'Success';

function fail_function(s)
% Make a function call that should fail

caught=false;
try
    eval(s)
catch
    %fprintf([lasterr '\n']);
    caught=true;
end

if not(caught)
    error(['function call ''' s ''' did not fail, but should have'])
end

function h=show(i)

h=figure;
imagesc(i);
colormap(gray);
drawnow
